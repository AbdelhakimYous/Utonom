name: Deploy Laravel backend to Azure Web App
on:
  push:
    branches:
      - master
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        
      - name: Setup PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, json, bcmath, pdo, mysql
          
      - name: Copy .env file
        working-directory: ./backend
        run: cp .env.example .env || echo "APP_KEY=" > .env
        
      - name: Install Composer dependencies
        working-directory: ./backend
        run: composer install --prefer-dist --no-interaction --no-progress --optimize-autoloader --no-dev
        
      - name: Generate Laravel APP Key
        working-directory: ./backend
        run: php artisan key:generate --force
        
      - name: Clear and cache config
        working-directory: ./backend
        run: |
          php artisan config:clear
          php artisan config:cache
          php artisan route:cache || echo "Route cache failed - continuing"
          php artisan view:cache
          
      - name: Create web.config for Azure
        working-directory: ./backend
        run: |
          cat > web.config << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <configuration>
            <system.webServer>
              <rewrite>
                <rules>
                  <rule name="Laravel" stopProcessing="true">
                    <match url="^" ignoreCase="false" />
                    <conditions>
                      <add input="{REQUEST_FILENAME}" matchType="IsDirectory" ignoreCase="false" negate="true" />
                      <add input="{REQUEST_FILENAME}" matchType="IsFile" ignoreCase="false" negate="true" />
                    </conditions>
                    <action type="Rewrite" url="index.php" />
                  </rule>
                </rules>
              </rewrite>
              <defaultDocument>
                <files>
                  <clear />
                  <add value="index.php" />
                </files>
              </defaultDocument>
            </system.webServer>
          </configuration>
          EOF
          
      - name: Set correct permissions
        working-directory: ./backend
        run: |
          chmod -R 775 storage
          chmod -R 775 bootstrap/cache
          
      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'utonomutlisateur'
          package: './backend'
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
